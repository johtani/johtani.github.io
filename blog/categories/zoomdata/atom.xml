<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: zoomdata | @johtaniの日記 2nd]]></title>
  <link href="http://blog.johtani.info/blog/categories/zoomdata/atom.xml" rel="self"/>
  <link href="http://blog.johtani.info/"/>
  <updated>2019-10-10T16:55:50+09:00</updated>
  <id>http://blog.johtani.info/</id>
  <author>
    <name><![CDATA[johtani]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[fluent-plugin-zoomdata作りました＋悩み事とか]]></title>
    <link href="http://blog.johtani.info/blog/2013/06/03/fluent-plugin-zoomdata-0-0-1/"/>
    <updated>2013-06-03T13:43:00+09:00</updated>
    <id>http://blog.johtani.info/blog/2013/06/03/fluent-plugin-zoomdata-0-0-1</id>
    <content type="html"><![CDATA[<p>憧れ？のfluentを使ってみました。
<a href="http://atl.recruit-tech.co.jp/blog/668/">こちらの記事</a>で紹介した<a href="http://zoomdata.com">Zoomdata</a>を最近触っているのですが、お試しにfluentdでデータ流し込むプラグインを作ってみようかなぁと。（今は、Javaでの接続も書いていて、主にそっちを使っています。）
ということで、作ってみました。<a href="https://github.com/johtani/fluent-plugin-zoomdata">fluent-plugin-zoomdata</a>。</p>

<p>基本的にはtagomoris先生の<a href="https://github.com/tagomoris/fluent-plugin-growthforecast">fluent-plugin-growthforecast</a>を参考（パクリ？）にさせてもらいました。
作っている最中もここわからんってツイートに反応していただき、大変助かりました。
私はベースがJavaの人間なので、手探り状態でRubyを書いています。そこおかしいんじゃないの？とかあればコメントもらえると嬉しいです。</p>

<!-- more -->


<h2>ZoomdataのAPI</h2>

<p>ZoomdataのAPIはこんなかんじで、JSONをHTTPSでPOSTするものになります。</p>

<script src="https://gist.github.com/wlindner/4587444.js"></script>


<p>指定する必要があるものは、以下の項目です。</p>

<ul>
<li>source：Zoomdataのデータ保存先（Zoomdataでのデータを保存する単位。）</li>
<li>user：Zoomdataのユーザ名</li>
<li>password：Zoomdataのユーザのパスワード</li>
<li>JSONデータ：Zoomdataでグラフ化するデータ</li>
</ul>


<p>sourceはデータ保存先の名称で、この単位でZoomdataはデータを保存、描画します。fluentdのタグをこれにするとわかりやすいかなぁ？と考えていったん、実装してみています。</p>

<p>で、作成したプログラムを使いつつ、Zoomdataの検証をしたかったので、つぎのような簡単なプログラムを作って動かしてみました。</p>

<h2>サンプルプログラムの構成</h2>

<p>基本的にJavaの人なので、クライアントはJavaで書いてます。
CLIプログラムで適当なJSONを作って、fluent-loggerを使って、fluentdに投げ込みます。</p>

<p><img src="/images/entries/sample_pg_zoomdata.jpg" width="500" title="&lsquo;sample program and server&rsquo;" ></p>

<p>fluentdにfluent-plugin-zoomdataを設定して、localのZoomdataサーバに対してHTTPSでJSONをPostする仕組みです。(初keynote)<br/>
利用しているライブラリなどのバージョンは次の通り</p>

<ul>
<li>td-agent.x86_64：1.1.12-0</li>
<li>fluent-logger：0.2.8</li>
<li>Zoomdata：1.0.3</li>
</ul>


<h2>バグ？</h2>

<p>で、Zoomdataにいろんなデータを流し込んでみたのですが、つぎのようなエラーが出て、エラーが出力されたあとはZoomdataにデータが流れ込まなくなってしまいました。</p>

<pre><code>2013-06-03 14:42:33 +0900 [warn]: emit transaction failed  error="SSL_connect returned=1 errno=0 state=SSLv3 read finished A: sslv3 alert handshake failure"
  2013-06-03 14:42:33 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/1.9.1/net/http.rb:799:in `connect'
  2013-06-03 14:42:33 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/1.9.1/net/http.rb:799:in `block in connect'
  2013-06-03 14:42:33 +0900 [warn]: /usr/lib64/fluent/ruby/lib/ruby/1.9.1/timeout.rb:54:in `timeout'
</code></pre>

<p><a href="https://gist.github.com/johtani/5696295">全ログはこちら</a>。</p>

<p>まだきちんと問題を調査しないでブログを書いています、すみません。</p>

<h3>現象</h3>

<p>ログが発生した時の症状です。</p>

<ul>
<li>クライアントプログラムは送信が続いており、エラーは出ない</li>
<li>td-agent.logに先ほどのエラーが出力</li>
<li>別途<code>type file</code>にて出力しているログも停止</li>
</ul>


<h3>想像</h3>

<p>とりあえず、ログを見た想像、所感です。</p>

<ul>
<li>問題の箇所はfluent-plugin-zoomdataからZoomdataサーバへのデータ送信部分</li>
<li>emit処理内部で、HTTPSでデータをPOSTする処理でエラーが起きて</li>
<li>リトライ処理とか書いてないので、emitがコケて、その後データが送信されなくなる</li>
<li>emitで例外をつかみそこねてるのがあるから止まってる？</li>
</ul>


<p>とまぁ、ちゃんと仕組みを理解しないでRubyとか書くからこうなるんですねぇ。
あとでちゃんと調べて考えて、改良してブログ書きます。</p>

<h2>悩んでいる点、今後手を入れたい点</h2>

<p>上記バグとは別に作りの点でいくつか悩んでる点も書いてみます。</p>

<h3>BufferedOutputにしてみたい</h3>

<p>fluentdのバッファリングを使って、Zoomdataが落ちていても使えるようにしたいと思っているのでBufferedOutputで書くのがいいのかなぁとか。
ちょうど<a href="http://www.slideshare.net/harukayon/fluentd-22317236">いいスライド</a>があったので、読みながらまずは中身を理解してみよう。</p>

<h3>Zoomdataのsource、userなどの扱い</h3>

<p>基本的には設定ファイルで切り替えるのが妥当かなぁと思っています。<br/>
ただ、Zoomdataのsourceやuserが増えるたびにfluentdの設定を書き換えて再起動するのかなぁと。userはしょうが無いにしても、sourceは設定じゃない所で切り替えたいなぁと。</p>

<p>で、切り替えるのにつぎの案があるかなぁと。</p>

<ol>
<li>タグで指定（今実装してるもの）</li>
<li>メッセージにメタ情報とボディ構造を設ける</li>
<li>設定をどんどん増やす（やりたくない）</li>
</ol>


<p>1と3はまぁ、いいかと。2.のパターンはどうなのかなぁと。
毎回のメッセージでヘッダ部分が送信されるのはなんだか無駄だなぁというのが否めないので悩ましいところです。1、2の両方対応できるように作るのもありか。</p>

<pre><code class="json">{
    "header": {
        "source": "source_name", 
        "user": "userid",
        "password": "userid",
    },
    "body": {
        "label": "label1",
        "count": 1
    }
}
</code></pre>

<p>ということで、fluent触って遊ぶの楽しいですね。Rubyの勉強にもなりそうだし。
ちょっとずつ頑張ってみようかなぁと。
まぁ、まだ私以外にニーズは無さそうなプラグインですが。</p>
]]></content>
  </entry>
  
</feed>
