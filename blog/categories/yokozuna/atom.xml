<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: yokozuna | @johtaniの日記 2nd]]></title>
  <link href="http://blog.johtani.info/blog/categories/yokozuna/atom.xml" rel="self"/>
  <link href="http://blog.johtani.info/"/>
  <updated>2015-02-27T17:06:30+09:00</updated>
  <id>http://blog.johtani.info/</id>
  <author>
    <name><![CDATA[johtani]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Riak Meetup #3 #riakjp に参加しました。]]></title>
    <link href="http://blog.johtani.info/blog/2013/11/06/riak-meetup-tokyo-no3/"/>
    <updated>2013-11-06T23:01:00+09:00</updated>
    <id>http://blog.johtani.info/blog/2013/11/06/riak-meetup-tokyo-no3</id>
    <content type="html"><![CDATA[<p>またまた、<a href="http://connpass.com/event/3600/">Riak Meetup Tokyo #3</a>に参加してきました。Riak2.0のYokozunaの話があると聞いたので。</p>

<p><img src="/images/entries/20131107/bakusoku.jpg" width="300" title="ステッカー" ></p>

<p>ということで、いつものように個人メモです。</p>

<!--  more -->


<p>今日は自重して、懇親会はアルコールなしにしました。思いがけずfluentd＋elasticsearch+kibanaという組み合わせの話も聞けて大満足です。
Yokozunaのデモが見れなかったのがちょっと残念だったかなぁ。</p>

<p>少しだけSolr本の宣伝もしてきちゃいました。</p>

<h2>古城さん@Mixi 「RiakCSとmixi プライベートクラウド環境」</h2>

<h3>プライベートクラウドとは？</h3>

<ul>
<li>計算リソースが安い（ストレージは微妙）</li>
<li>開発者が好きに使える環境＋運用側のチケットに追われる毎日からの開放</li>
</ul>


<h3>Riak CSの概要</h3>

<ul>
<li>S3互換の分散ファイルストレージ</li>
</ul>


<h3>検証とか</h3>

<ul>
<li>検証時はRiak CS 1.3</li>
<li><p>5ノードで2Mファイルを40万個</p></li>
<li><p>削除は遅延で削除される</p></li>
<li><p>PUT性能とか。</p></li>
<li><p>Riak CSの死活監視にはRiakのstatsとか</p></li>
<li><p>障害対応とか</p></li>
</ul>


<h3>クラスタ</h3>

<ul>
<li>クラスタは3つ。ログ、サービス（画像） 、バックアップ保存用</li>
<li>ログの収集にfluentd、解析に<strong>elasticsearch</strong>や<strong>kibana</strong>を使っているらしい。</li>
</ul>


<h2>篠原＠Basho 「Riak 2.0: 分散データ型、セキュリティ、そしてより容易な運用へ」</h2>

<ul>
<li>riak 2.0 pre5をリリース</li>
<li>アプリ向け機能強化、運用の容易性</li>
</ul>


<h3>設計ポリシーとか、1.xとか</h3>

<ul>
<li>運用、高可用性、水平拡張性</li>
<li>Capabilityネゴシエーションとか</li>
</ul>


<h3>2.0の機能強化</h3>

<h4>バケットタイプ</h4>

<ul>
<li>キーの名前空間としてバケットがあったけど、同種のバケットをまとめて管理とかしたくなった。</li>
<li>データ型の導入（CRDT）</li>
<li>Setデータ型</li>
<li>セキュリティとか</li>
<li>強い整合性&hellip;</li>
</ul>


<h2>鈴木@Basho 「Yokozuna: Riak 2.0の新しい全文検索機能」</h2>

<h3>YokozunaやSolrの概要</h3>

<ul>
<li>1ノードにRiakとSolrが1プロセスずつ</li>
<li>SolrプロセスはRiakが管理してくれる</li>
<li>SolrCloudは使ってません。</li>
<li>Riakのノードに届いたデータをSolrに裏で書き込んでくれる。</li>
<li>検索時にはRiakのノードが分散検索をしてくれる</li>
<li>X-Riak-Metaもインデクシングしてくれる。jsonやxmlの各要素をSolrのフィールドとして認識してくれる。</li>
<li>Extractor</li>
</ul>


<p>Solrは4.4で、JVMは1.7をユーザが入れるらしい。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第12回Solr勉強会を主催しました。#SolrJP]]></title>
    <link href="http://blog.johtani.info/blog/2013/10/10/solr-meetup-memo/"/>
    <updated>2013-10-10T11:35:00+09:00</updated>
    <id>http://blog.johtani.info/blog/2013/10/10/solr-meetup-memo</id>
    <content type="html"><![CDATA[<p>不定期開催ですが<a href="http://atnd.org/events/43532/">第12回Solr勉強会</a>を主催しました。</p>

<p>今回は、前回ほどの過熱ぶりでは無かったですが、70人ほどの参加者の方がいらっしゃったかと。
ありがとうございます！</p>

<p>今回は聞きたかったYokozunaの話をしてもらいました。あと、リベンジManifoldCF。
<em>一部、追記しました。Bashoさんからツッコミがあったので。あと、4.5.1の話とか。</em></p>

<!-- more -->


<h2>ManifoldCFのとSolrの組み合わせ（仮）株式会社 ロンウイット　大須賀　稔さん</h2>

<p>前回お休みだったのでリベンジですw。</p>

<p>英語だ。。。やっぱ英語がいいですか、スライド。。。<br/>
ManifoldCFの概要から。
最新版は1.3です。色々サポートしてるなぁ。</p>

<p>デモもありました。（やっぱりちゃんと動かないので、鬼門みたいですが）</p>

<h4>デモ</h4>

<p>ManifoldCFのGUIで操作しながら。
いまいちちゃんと動かなかった。。。</p>

<h4>QA</h4>

<ul>
<li>Q:Zipはうまく動かなかった</li>
<li>A:Solr側で処理してくれてる。</li>
<li>Q:Notes対応するの？</li>
<li>A:いまのところない。</li>
<li>Q:ExcelとかPDFはTika？</li>
<li>A:Tika次第です。</li>
<li>Q:認証周りどこから取ってくるの？</li>
<li>A:クローラ側にはなくて、SharePointとかの権限をみてる。</li>
<li>Q:Web系の認証は？</li>
<li>A:まだないのでは。。。（調査します）</li>
</ul>


<p>あー、デモの続き忘れてましたね。。。</p>

<h2>Solrを組み込んだRiak 2.0の全文検索機能 -Yokozuna- Bashoジャパン株式会社　鈴木　一弘さん</h2>

<p>Riak色々使われてるよ！アングリーバードとか、Y!とか。
Riakで提供されている1機能としてのYokozuna。単独製品ではないですよと。</p>

<p>Riakの説明。スケールするよ、いつでもRead/Writeできるよ、運用にフォーカスしてるよと。
マスターレスですよ。
Riak2.0のリリースは2013年末。Yokozunaもかな？</p>

<p>ダイナミックフィールド使ってるので、Yokozunaをonにするだけで簡単に使えるよ。</p>

<p>RiakがSolrのプロセスを管理。</p>

<p>インデックスの不整合の検知とかってどうやってるのかなぁ？
インデックス比較用のハッシュツリーをノード間でコピーしつつ検査してる。（Active Anti-Entropy）</p>

<p>(デモには魔物がいるようだ。。。)</p>

<h4>QA</h4>

<ul>
<li>Q:JSONの属性を元にしてフィールドにインデックス可能か？</li>
<li>A:可能です。IIJさんの発表で話が出ます。</li>
<li>Q:ProtocolBufferでSolrにアクセス可能？</li>
<li>A:<strike>そのうちできそうです。</strike>リリース時にはできるようになっています。</li>
<li>Q:コアのスワップは？スキーマの変更は？</li>
<li>A:事前に設定するのは可能。</li>
<li>Q:RiakのデータとSolrでデータがずれるってのはあるの？</li>
<li>A:可能性はありますが、<strike>極力ずれ</strike>AAEで修復。</li>
<li>Q:復旧中のインデックスにアクセスが行かないようにする仕組みなどはある？</li>
<li>A:今はないです。</li>
</ul>


<h2>Yokozuna ベンチマークしました　株式会社インターネットイニシアティブ　曽我部　崇さん、田中 義久さん</h2>

<p>いいとこ取りで楽だなぁと。いうことで、試してみてます。
デモが動いてる。</p>

<p>extractorでXMLやJSONをパースできる。
ベンチマーク結果。</p>

<p>Riak Meetup Tokyo #2の時のQAも入ってるので助かります。素晴らしい。</p>

<h4>QA</h4>

<ul>
<li>Q:スナップショットは両方取れるの？</li>
<li>A:Riakは取れますが、インデックスは今は無理です。</li>
<li>フォロー:0.8はYokozunaにボトルネックがあったので、0.9以降だともっと性能が出るはずですとのこと。また次回とかに発表してもらうのもありですかねぇ。</li>
</ul>


<h2>Solr 4.5の新機能など @johtani</h2>

<p><a href="/images/entries/20131009/Solr4_5_Changes.pdf">発表資料のPDF</a>です。</p>

<p>ツイート見てて誤解を招いたなと思ったのですが、7u40は4.5限定ではなく、すべてのバージョンと考えてください。
チケットを見ると分かりますが、影響バージョンの記載はありません。</p>

<p>※あ、4.5のChangesを紹介しましたが、4.5.1が出るかも。このへんが困ってるらしいです。</p>

<ul>
<li><a href="https://issues.apache.org/jira/browse/SOLR-5306">SOLR-5306: can not create collection when have over one config</a></li>
<li><a href="https://issues.apache.org/jira/browse/SOLR-5317">SOLR-5317: CoreAdmin API is not persisting data properly</a></li>
<li><a href="https://issues.apache.org/jira/browse/LUCENE-5263">LUCENE-5263: Deletes may be silently lost if an IOException is hit and later not hit (e.g., disk fills up and then frees up)</a></li>
</ul>


<h2>LT</h2>

<h3>@haruyama さん</h3>

<p>資料：<a href="http://haruyama.github.io/solr_20131009/#(1">http://haruyama.github.io/solr_20131009/#(1)</a>)</p>

<p>記号が捨てられるTokenizer困るので、捨てないのを作ってみました。</p>

<p>Kuromojiの困ったこと。全角数字を分解しちゃう。→MappingCharFilterFactoryで全角から半角にしましょう。
lucene-gosenデフォで半角記号が未知語になってしまい、半角カナと混ざるので、記号を全角にしましょう。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Yokozunaの気になる点というかなんというか]]></title>
    <link href="http://blog.johtani.info/blog/2013/07/11/yokozuna-check-point/"/>
    <updated>2013-07-11T01:43:00+09:00</updated>
    <id>http://blog.johtani.info/blog/2013/07/11/yokozuna-check-point</id>
    <content type="html"><![CDATA[<p>Yokozunaの気になる点というか、自分だったらこのへん調べるだろうなって観点を上げてみます。
別に調べるわけじゃないので、完全に自己満足なメモですけど。<br/>
ちなみに、分散システムとかRiakの仕組みは詳しくないので、ズレてる点がいっぱいあるかも。<br/>
というか、分散システムでテストというか、検討する点とかってまとまってる資料とかあるのかなぁ？</p>

<!-- more -->


<ul>
<li>スキーマ変更時の挙動

<ul>
<li>フィールド型変更とか、フィールド追加とか</li>
</ul>
</li>
<li>既存RiakクラスタにYokozunaの機能を追加する方法と制限

<ul>
<li>タイムラグとかも</li>
</ul>
</li>
<li>Riak＋Yokozunaクラスタに対してノード追加時に発生するオーバーヘッド（ネットワークとかディスクIOとか）</li>
<li>性能検証のためのシナリオ（どっちが先に悲鳴をあげるかとか）

<ul>
<li>Riakメインで、Yokozunaはおまけ程度に検索するというシナリオ</li>
<li>Yokozunaメインで使うシナリオ</li>
<li>更新が多い場合のシナリオ</li>
</ul>
</li>
<li>Riakのみ、Riak＋Yokozunaの各種統計情報（CPU、メモリ、ディスクサイズ、ネットワークIO）</li>
<li>運用系（監視とか）の手法とか機能？とか</li>
<li>バージョンアップなどの対応方法</li>
<li>Solrがコケた時とかの対処</li>
</ul>


<p>とりあえず、こんな感じかなぁ。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Riak Meetup Tokyo #2に参加しました。#riakjp]]></title>
    <link href="http://blog.johtani.info/blog/2013/07/10/riak-meetup-tokyo-no2/"/>
    <updated>2013-07-10T18:57:00+09:00</updated>
    <id>http://blog.johtani.info/blog/2013/07/10/riak-meetup-tokyo-no2</id>
    <content type="html"><![CDATA[<p>先日、Bashoさんにおじゃましたのもあり、<a href="http://connpass.com/event/2656/">Riak Meetup Tokyo #2</a>に参加しました。<br/>
Yokozunaの話も聞けるということで。
懇親会も参加しました。Vさん＆リピさんと話し込んじゃってあんまり他の人と話せなかったけど。。。</p>

<p>以下はいつものメモです。</p>

<!-- more -->


<h2>FreakOut 久森さん 「Riak環境をプロダクションで構築＆運用してみた（仮）」</h2>

<h3>FreakOutとRTB</h3>

<ul>
<li>ディスプレイ広告の新しい配信の枠の話</li>
<li>この人には何出すの？いくらで？みたいな感じ</li>
<li>純広告：表示保証、期間保証など</li>
<li>RTB：1回の広告表示ごとに買い付け</li>
<li>DSP（デマンド・サイト・プラットフォーム）</li>
<li>広告表示は大体0.1秒で表示しないといけない。この間に色々やってる。

<ul>
<li>50ms or die.で戦ってます。</li>
</ul>
</li>
<li>RTBはCPUバウンド

<ul>
<li>多コアを安く並べたい</li>
<li>Tokyoなんとかとか使ってた。

<ul>
<li>スケーラビリティがキツイ（クライアント側でアルゴリズム分散してる）</li>
<li>データ解析もしたいけど、検索ができない</li>
</ul>
</li>
<li>RTBに適したRiakがうまくハマるのではと。</li>
</ul>
</li>
</ul>


<h3>構成とかとか</h3>

<ul>
<li>アプリはPerlなので、PerlでRiakクライアントが必要。Memcached互換とかあると嬉しい。</li>
<li>ProtobufサポートもPurePerlしかなかった。</li>
<li>ないなら、作ろうと。<a href="https://github.com/myfinder?tab=repositories">githubに上がってます。このへんかな？</a></li>
<li>監視はcloudforecastとかでやってる。</li>
</ul>


<h3>課題</h3>

<ul>
<li>Redirectがつらい（haproxy？がつらい？）</li>
<li>Setが詰まるとつらい（ケースがまだわからない）</li>
<li>対策１

<ul>
<li>memcached＋Riak</li>
</ul>
</li>
<li>対応２（案）

<ul>
<li>hashからpartitionに直接取りに行くとか</li>
</ul>
</li>
</ul>


<h3>まとめ</h3>

<ul>
<li>素のままRiakはちょっとつらい</li>
</ul>


<h4>QA</h4>

<p>聞き取れたやつだけ</p>

<ul>
<li>Q：1台いくら位ですか？

<ul>
<li>A：10万から11万くらい</li>
</ul>
</li>
<li>Q：どのくらいの性能ですか？

<ul>
<li>A：同時1000くらいをさばいてる？</li>
</ul>
</li>
<li>Q：50ms以下を出すのに、ネットワーク周りで近さとかを考えることありますか？

<ul>
<li>A：国内だと10msあればなんとかなる。それよりもアプリ側のチューニングのほうがまだ重要</li>
</ul>
</li>
<li>Q：Cassandraとか候補に挙がらなかったんですか？

<ul>
<li>A：苦しんでる人が知人にいるので。。。あと、用途的に違うので。</li>
</ul>
</li>
<li>Q：バックエンドとしてはなにを？

<ul>
<li>A：bitcaskにしてる</li>
</ul>
</li>
<li>Q：サーバ構成、ネットワーク構成がどうなってる？

<ul>
<li>A：。。。</li>
</ul>
</li>
<li>Q：Redirectとは？RiakがやってるRedirect？

<ul>
<li>A：はい。</li>
</ul>
</li>
<li>Q：他に候補にあがったのは？

<ul>
<li>A：<a href="http://www.aerospike.com">商用のaerospike（これかな？）</a>がスケールできそうだったけど、クライアントがいまいち。。。</li>
</ul>
</li>
</ul>


<h3>感想</h3>

<p>広告業界のことをよくわかってないので、微妙にピンときてなかったりもするのですが、以下に素早く返すかって観点でどこに注力して、問題点を潰していくのかってのは面白そうだなぁと。
リクエスト処理の性能がクリアできたらつぎはスケールの観点（ノード追加時の挙動とか）で検証していくんだろうなと。次回の話も聞いてみたい感じです。</p>

<h2>IIJ 曽我部さん、田中さん 「Yokozuna 日本語検索性能を評価しました」</h2>

<h3>Yokozunaって？</h3>

<ul>
<li>Riak＋Solrでいいとこ取り</li>
<li>データの登録とかはRiakのAPIで。</li>
<li>SolrのAPIが使える。</li>
<li>YokozunaがSolrの分散検索の部分を隠してくれる。</li>
</ul>


<h3>Yokozunaのインストールとか。</h3>

<ul>
<li>SolrのAPIっぽい形で検索できるし、戻りもSolrのXMLっぽいのが出てくるよ。</li>
</ul>


<h3>Wikipediaデータってstoreの性能とか。</h3>

<ul>
<li>Riakのノード32台。（Xeon、メモリ24GB、HDD。。。）</li>
<li>yz_extractor：Riakのコンテンツタイプを見てSolrにデータを入れる処理が書いてある。</li>
<li>自分でschema.xmlを書いてYokozunaに指定することもできる。

<ul>
<li>スキーマの変更とか登録とか。

<ul>
<li>すでに指定済みスキーマを変更した場合の挙動ってどうなるの？</li>
</ul>
</li>
</ul>
</li>
<li>デモではSolrからid取って、Riakからその他のデータを取り出していた。</li>
</ul>


<h4>Rubyでの性能評価</h4>

<ul>
<li>ベンチマークプログラム側の問題が先に影響が出てしまった。</li>
</ul>


<h3>QA</h3>

<ul>
<li>Q：Riak単体とYokozunaつかった時でディスク容量がどのくらい増えた？

<ul>
<li>A：ちゃんと調べてないが、10%くらい増えた気がする。</li>
</ul>
</li>
<li>Q：Solr側の設定でstored=trueだけど、falseにしてもいいんじゃないの？

<ul>
<li>A：デモはfalseにしてます。</li>
</ul>
</li>
<li>Q：スキーマってあとから変更できるんですかね？

<ul>
<li>A：まだ良くわかってないです。</li>
</ul>
</li>
<li>Q：ノードの追加、削除時の挙動とかも気になります。</li>
</ul>


<h3>感想</h3>

<p>今回はStore性能に関してでしたが、今後は検索性能やシナリオによる性能（KVSの処理メインで、時々全文検索とか、全文検索の処理も結構あるパターンとか）の測定とか、耐障害性とかの観点で調査を進めてもらってSolr勉強会で話をしてもらえると面白そうだなぁと勝手に思ってみたり。
Solr勉強会へのコンタクトお待ちしてます！ｗ</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Basho Japanに遊びに行きました]]></title>
    <link href="http://blog.johtani.info/blog/2013/06/19/visited-basho/"/>
    <updated>2013-06-19T10:03:00+09:00</updated>
    <id>http://blog.johtani.info/blog/2013/06/19/visited-basho</id>
    <content type="html"><![CDATA[<p>ちょくちょく書こうと言いながら、前の記事が1週間以上前になってる。。。</p>

<p>昨日は、Basho Japanに遊びに行って来ました。
（Riak触ったことないのに。。。Erlangも。。。ゴメンナサイ）</p>

<!-- more -->


<p>RiakにSolrを組み合わせたYokozunaというものの名前を最近耳にしていたので、どんなものなのかなぁと興味がありまして。Solrがどんな使い方をされているのかってのが気になったので、
情報交換したいなぁと思っていたところ、Vの人が調整してくれたので色々と有意義な話ができたかなぁと。
（Yokozunaについての最新のスライドは<a href="https://speakerdeck.com/rzezeski/yokozuna-scaling-solr-with-riak">Berlin Buzzword 2013のものがここに</a>）
Twitter上で見かけたことのある方々と話ができたり面白かったです。（やっぱ英語で会話できたりスラスラと読めるの必要だよなぁと痛感したりもしました。。。）</p>

<p>ということで、遊びに行ったのに美味しいピザやこんなおみやげまでもらってしまいました。
（ピザの写真撮るの忘れてたw）</p>

<p><img src="/images/entries/20130619/riak-goods.jpg" title="Riak＆Bashoグッズ" ></p>

<p>ちなみに、Yokozunaですが、Riakに登録したデータを裏で起動しているSolにデータを流しこんでくれるものになります。
Solrの機能としては分散検索（Distributed Search）と呼ばれる仕組みを利用しているようです。
YokozunaのI/Fとしては、Solrのインデックスの分散構成は隠してくれていて、かつ、Solr（っぽい？）リクエストを投げれば裏の分散構成に問い合わせた結果をSolrのレスポンスの形で返してくれます。
KVSに全文検索の機能がついてくるお得感が満載な気がしますw。</p>

<p>Riak自身のデータの取り扱いがどんなものかをまだちゃんと理解していないので（ゴメンナサイ。<a href="http://littleriakbook.com">Little Riak Book</a>は開いてるんですが読んでなくて。。。）またおじゃましてもう少し情報交換したいかなぁとｗ。</p>

<p>Cloudera Searchといい、Yokozunaといい、Solrを利用したものが少しずつ増えてきて嬉しい限りです。
Solrの作りがしっかりしている？活発？、だから取り込む形が多いんですかねぇ。
Solr本を書いてから数年たちますが、やっと検索のニーズが出てきたのかもしれないなぁと思ってみたり。
（流れのつながりはあまりないですが）ElasticSearchも少しずつ人気が出てきてるし、日本語の本とかのニーズあったりするかなぁ？</p>
]]></content>
  </entry>
  
</feed>
